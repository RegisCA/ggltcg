"""\nUnit tests for AI V4 dual-request architecture components.\n\nTests:\n- Example loader selection logic\n- Sequence generator prompt size\n- Strategic selector prompt size\n- Tactical label assignment\n"""\n\nimport sys\nfrom pathlib import Path\n\n# Add backend/src to path\nsys.path.insert(0, str(Path(__file__).parent.parent / "src"))\n\nfrom conftest import create_game_with_cards\n\n\nclass TestExampleLoader:\n    """Test the contextual example loader."""\n    \n    def test_returns_exactly_3_examples(self):\n        """Loader should always return exactly 3 examples."""\n        from game_engine.ai.prompts.examples.loader import get_relevant_examples\n        \n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge", "Knight", "Umbruh"],\n            player1_in_play=["Ka"],\n            player2_in_play=["Archer"],\n            active_player="player1",\n        )\n        \n        examples = get_relevant_examples(setup.game_state, "player1")\n        assert len(examples) == 3, f"Expected 3 examples, got {len(examples)}"\n    \n    def test_surge_knight_combo_detected(self):\n        """When Surge and Knight are in hand, surge_knight combo should be included."""\n        from game_engine.ai.prompts.examples.loader import get_relevant_examples\n        \n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge", "Knight"],\n            player1_in_play=[],\n            player2_in_play=[],\n            active_player="player1",\n        )\n        \n        examples = get_relevant_examples(setup.game_state, "player1")\n        \n        # Check that surge_knight combo is included\n        has_surge_knight = any("Surge + Knight" in ex for ex in examples)\n        assert has_surge_knight, "Surge+Knight combo should be detected when both in hand"\n    \n    def test_phase_example_based_on_turn(self):\n        """Phase example should match turn number."""\n        from game_engine.ai.prompts.examples.loader import get_game_phase\n        \n        assert get_game_phase(1) == "early_game"\n        assert get_game_phase(3) == "early_game"\n        assert get_game_phase(4) == "mid_game"\n        assert get_game_phase(6) == "mid_game"\n        assert get_game_phase(7) == "end_game"\n        assert get_game_phase(10) == "end_game"\n    \n    def test_no_duplicate_examples(self):\n        """Examples should not be duplicated."""\n        from game_engine.ai.prompts.examples.loader import get_relevant_examples\n        \n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge", "Knight", "Archer"],\n            player1_in_play=[],\n            player2_in_play=["Umbruh"],\n            active_player="player1",\n        )\n        \n        examples = get_relevant_examples(setup.game_state, "player1")\n        \n        # Check no duplicates\n        assert len(examples) == len(set(examples)), "Examples should not be duplicated"\n\n\nclass TestSequenceGenerator:\n    """Test the sequence generator prompt."""\n    \n    def test_prompt_under_4k_chars(self):\n        """Sequence generator prompt should be under 4k chars."""\n        from game_engine.ai.prompts.sequence_generator import generate_sequence_prompt\n        \n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge", "Knight", "Umbruh", "Drop"],\n            player1_in_play=["Ka", "Archer"],\n            player2_in_play=["Gibbers", "Wizard", "Paper Plane"],\n            active_player="player1",\n        )\n        \n        prompt = generate_sequence_prompt(setup.game_state, "player1")\n        \n        assert len(prompt) < 4500, f"Prompt too long: {len(prompt)} chars (target: <4500)"\n    \n    def test_prompt_includes_cc(self):\n        """Prompt should include current CC."""\n        from game_engine.ai.prompts.sequence_generator import generate_sequence_prompt\n        \n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge"],\n            player1_in_play=[],\n            player2_in_play=[],\n            active_player="player1",\n        )\n        \n        prompt = generate_sequence_prompt(setup.game_state, "player1")\n        \n        # V4 shows CC value in header\n        assert "## CC:" in prompt, "Prompt should include CC"\n    \n    def test_tactical_labels_assigned(self):\n        """Tactical labels should be assigned based on sequence content."""\n        from game_engine.ai.prompts.sequence_generator import add_tactical_labels\n        \n        sequences = [\n            {\n                "actions": [\n                    {"action_type": "tussle", "cc_cost": 2},\n                    {"action_type": "tussle", "cc_cost": 2},\n                    {"action_type": "end_turn", "cc_cost": 0}\n                ],\n                "total_cc_spent": 4,\n                "cards_slept": 2\n            },\n            {\n                "actions": [\n                    {"action_type": "play_card", "card_name": "Surge", "cc_cost": 0},\n                    {"action_type": "end_turn", "cc_cost": 0}\n                ],\n                "total_cc_spent": 0,\n                "cards_slept": 0\n            }\n        ]\n        \n        labeled = add_tactical_labels(sequences)\n        \n        assert labeled[0]["tactical_label"] == "[Aggressive Removal]"\n        assert labeled[1]["tactical_label"] == "[Resource Building]"\n\n\nclass TestStrategicSelector:\n    """Test the strategic selector prompt."""\n    \n    def test_prompt_under_5k_chars(self):\n        """Strategic selector prompt should be under 5k chars."""\n        from game_engine.ai.prompts.strategic_selector import generate_strategic_prompt\n        \n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge", "Knight"],\n            player1_in_play=["Ka"],\n            player2_in_play=["Archer", "Gibbers"],\n            active_player="player1",\n        )\n        \n        test_sequences = [\n            {\n                "actions": [{"action_type": "end_turn", "cc_cost": 0}],\n                "total_cc_spent": 0,\n                "cards_slept": 0,\n                "tactical_label": "[Conservative]"\n            },\n            {\n                "actions": [\n                    {"action_type": "tussle", "card_name": "Ka", "target_names": ["Archer"], "cc_cost": 2},\n                    {"action_type": "end_turn", "cc_cost": 0}\n                ],\n                "total_cc_spent": 2,\n                "cards_slept": 1,\n                "tactical_label": "[Aggressive Removal]"\n            }\n        ]\n        \n        prompt = generate_strategic_prompt(setup.game_state, "player1", test_sequences)\n        \n        assert len(prompt) < 5000, f"Prompt too long: {len(prompt)} chars (target: <5000)"\n    \n    def test_prompt_includes_examples(self):\n        """Strategic selector should include contextual examples."""\n        from game_engine.ai.prompts.strategic_selector import generate_strategic_prompt\n        \n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge", "Knight"],\n            player1_in_play=[],\n            player2_in_play=[],\n            active_player="player1",\n        )\n        \n        prompt = generate_strategic_prompt(setup.game_state, "player1", [\n            {"actions": [], "total_cc_spent": 0, "cards_slept": 0, "tactical_label": "[Test]"}\n        ])\n        \n        assert "<examples>" in prompt, "Prompt should include examples section"\n        assert "</examples>" in prompt, "Examples section should be closed"\n    \n    def test_convert_sequence_to_turn_plan(self):\n        """Converting sequence to turn plan should produce valid structure."""\n        from game_engine.ai.prompts.strategic_selector import convert_sequence_to_turn_plan\n        \n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge", "Knight"],\n            player1_in_play=[],\n            player2_in_play=["Archer"],\n            active_player="player1",\n        )\n        \n        sequence = {\n            "actions": [\n                {"action_type": "play_card", "card_name": "Surge", "cc_cost": 0},\n                {"action_type": "play_card", "card_name": "Knight", "card_id": "abc", "cc_cost": 1},\n                {"action_type": "end_turn", "cc_cost": 0}\n            ],\n            "total_cc_spent": 1,\n            "cards_slept": 0,\n            "tactical_label": "[Board Setup]"\n        }\n        \n        plan_data = convert_sequence_to_turn_plan(\n            sequence, setup.game_state, "player1", "Test reasoning"\n        )\n        \n        assert "action_sequence" in plan_data\n        assert len(plan_data["action_sequence"]) == 3\n        # cc_start comes from player.cc in game_state\n        assert plan_data["cc_start"] == setup.game_state.players["player1"].cc\n        assert plan_data["plan_reasoning"] == "Test reasoning"\n\n\nclass TestPromptSizes:\n    """Aggregate test for prompt size targets."""\n    \n    def test_both_prompts_within_targets(self):\n        """Both Request 1 and Request 2 prompts should be within targets."""\n        from game_engine.ai.prompts.sequence_generator import generate_sequence_prompt\n        from game_engine.ai.prompts.strategic_selector import generate_strategic_prompt\n        \n        # Create a complex game state\n        setup, _ = create_game_with_cards(\n            player1_hand=["Surge", "Knight", "Umbruh", "Drop", "Wake", "Archer"],\n            player1_in_play=[],\n            player2_in_play=["Gibbers", "Wizard", "Paper Plane"],\n            active_player="player1",\n        )\n        \n        # Test Request 1\n        seq_prompt = generate_sequence_prompt(setup.game_state, "player1")\n        print(f"Request 1 (Sequence Generator): {len(seq_prompt)} chars")\n        assert len(seq_prompt) < 4500, f"Request 1 too long: {len(seq_prompt)} chars"\n        \n        # Test Request 2 with multiple sequences\n        test_sequences = [\n            {"actions": [{"action_type": "end_turn", "cc_cost": 0}], "total_cc_spent": 0, "cards_slept": 0, "tactical_label": f"[Seq{i}]"}\n            for i in range(5)\n        ]\n        \n        select_prompt = generate_strategic_prompt(setup.game_state, "player1", test_sequences)\n        print(f"Request 2 (Strategic Selector): {len(select_prompt)} chars")\n        assert len(select_prompt) < 5000, f"Request 2 too long: {len(select_prompt)} chars"\n